<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tous les jeux</title>
    <style>
        :root {
            --background: #f0f0f0;
            --text-color: #222;
            --card-bg: white;
            --card-shadow: 0 2px 5px rgba(0,0,0,0.1);
            --border-color: #ddd;
        }

        body.theme-dark {
            --background: #181a1b;
            --text-color: #f4f4f4;
            --card-bg: #23272b;
            --card-shadow: 0 2px 5px rgba(0,0,0,0.3);
            --border-color: #444;
        }

        body {
            font-family: sans-serif;
            background: var(--background);
            color: var(--text-color);
            margin: 0;
            padding: 1rem;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden; /* Prevent horizontal scrollbar */
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Limit maximum columns to 7 */
        @media (min-width: 1200px) {
            .grid {
                grid-template-columns: repeat(7, 1fr);
            }
        }
        .game {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s, background-color 0.3s;
            border: 1px solid var(--border-color);
            /* Remove flex and aspect-ratio from .game */
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Responsive game card adjustments */
        @media (max-width: 480px) {
            .game {
                border-radius: 6px;
            }
            
            .game-title {
                padding: 0.4rem;
                font-size: 1rem;
                line-height: 1.2;
            }
            
            .new-badge {
                font-size: 0.7em;
                padding: 1px 8px;
                top: 5px;
                left: 5px;
            }
        }
        .game-cover {
            aspect-ratio: 0.73;
            width: 100%;
            background: #222;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .game-cover img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #222;
            display: block;
        }
        .game-title {
            padding: 0.5rem;
            color: var(--text-color);
            background: var(--card-bg);
            text-decoration: none !important;
            border-bottom: none !important;
            font-weight: bold;
            font-size: 1.2rem;
            line-height: 1.3;
        }
        .game-link {
            text-decoration: none !important;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .theme-toggle {
            background: none;
            border: 2px solid var(--text-color);
            color: var(--text-color);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .theme-toggle:hover {
            background: var(--text-color);
            color: var(--background);
        }
        .random-game-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .random-game-btn:hover {
            background-color: #45a049;
        }
        .random-info-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.2rem;
            text-align: center;
            font-style: italic;
        }
        body.theme-dark .random-info-text {
            color: #aaa;
        }
        .browser-warning {
            background-color: #ffecb3;
            border-left: 4px solid #ff9800;
            padding: 12px 16px;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none; /* Hidden by default */
        }
        .browser-warning p {
            margin: 0;
            font-size: 0.95rem;
        }
        body.theme-dark .browser-warning {
            background-color: #664d00;
            color: #f4f4f4;
        }
        .game-new {
            border: 2.5px solid #ff9800 !important;
            box-shadow: 0 0 0 3px #fff6, 0 2px 8px #ff980055;
            position: relative;
        }
        .new-badge {
            position: absolute;
            top: 7px;
            left: 7px;
            background: linear-gradient(90deg, #ff9800, #ffc107);
            color: #fff;
            font-weight: bold;
            font-size: 0.82em;
            padding: 2px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px #ff980055;
            z-index: 2;
            letter-spacing: 1px;
            pointer-events: none;
        }
        
        /* Search functionality styles */
        .search-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .search-input {
            flex: 1;
            max-width: 600px;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s;
        }
        .search-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        .search-input::placeholder {
            color: #999;
        }
        .search-info {
            font-size: 0.9rem;
            color: #666;
            margin-left: 1rem;
        }
        body.theme-dark .search-info {
            color: #aaa;
        }
        .filter-count {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
            white-space: nowrap;
        }
        body.theme-dark .filter-count {
            color: #aaa;
        }
        .no-results {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-style: italic;
        }
        body.theme-dark .no-results {
            color: #aaa;
        }
        
        /* Mobile responsive fixes */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }
            
            .search-container {
                width: 100% !important;
                margin-bottom: 1rem !important;
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 0.5rem !important;
            }
            
            .search-container > *:not(.filter-count) {
                width: 100% !important;
                margin: 0 !important;
                border-radius: 8px !important;
            }
            
            .filter-count {
                text-align: center !important;
                margin-top: 0.5rem !important;
                font-size: 0.8rem !important;
            }
            
            .search-input {
                width: 100%;
                max-width: none;
                box-sizing: border-box;
                border-radius: 8px !important;
            }
            
            .random-game-btn {
                font-size: 0.9rem;
                padding: 0.6rem 1rem;
                white-space: nowrap;
                min-width: auto;
                width: auto;
            }
            
            .theme-toggle {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
                min-width: auto;
                width: auto;
            }
            
            #back-home-btn {
                font-size: 0.9rem;
                padding: 0.5rem 1rem;
                white-space: nowrap;
                min-width: auto;
                width: auto;
            }
            
            #header-container {
                gap: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            #header-buttons {
                gap: 0.3rem !important;
            }
        }
        
        /* Extra small mobile devices */
        @media (max-width: 480px) {
            body {
                padding: 0.3rem;
            }
            
            .search-container {
                margin-bottom: 0.8rem !important;
                gap: 0.3rem !important;
            }
            
            .random-game-btn {
                font-size: 0.8rem;
                padding: 0.5rem 0.8rem;
            }
            
            .theme-toggle {
                font-size: 0.7rem;
                padding: 0.3rem 0.6rem;
            }
            
            #back-home-btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
            
            /* Ensure header text wraps properly */
            .header-content h1 {
                font-size: 1.2rem;
                line-height: 1.3;
                word-break: break-word;
                overflow-wrap: break-word;
            }
            
            .header-content h2 {
                font-size: 1rem;
                line-height: 1.3;
                word-break: break-word;
                overflow-wrap: break-word;
            }
        }
        
        /* Very small screens */
        @media (max-width: 360px) {
            .header-content h1 {
                font-size: 1.1rem;
            }
            
            .header-content h2 {
                font-size: 0.9rem;
            }
        }
        
        /* Smooth transitions for show/hide */
        #header-container, #header-content {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        #header-container[style*="display: none"], #header-content[style*="display: none"] {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        /* Prevent layout shifts and scrollbar appearance */
        html, body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
        
        /* Ensure grid layout remains stable */
        .grid {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            display: block;
        }
        
        /* Section headers styling */
        .section-header {
            margin: 1rem 0 0.5rem 0;
            padding: 0.3rem 0;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--background);
            z-index: 10;
        }
        
        .section-header h2 {
            margin: 0;
            font-size: 3rem;
            font-weight: bold;
            color: var(--text-color);
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        
        .section-games {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.2rem;
            margin-bottom: 0.5rem;
            width: 100%;
        }
        
        /* Limit maximum columns to 7 for section games */
        @media (min-width: 1200px) {
            .section-games {
                grid-template-columns: repeat(7, 1fr);
            }
        }
        
        /* Responsive section adjustments */
        @media (max-width: 768px) {
            .section-header {
                margin: 0.8rem 0 0.4rem 0;
                padding: 0.2rem 0;
            }
            
            .section-header h2 {
                font-size: 2.2rem;
                letter-spacing: 2px;
            }
            
            .section-games {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 12px;
                margin-bottom: 0.3rem;
                width: 100%;
            }
        }
        
        /* Prevent any horizontal overflow */
        * {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Ensure header content doesn't overflow */
        .header-content {
            width: 100%;
            max-width: 100%;
            overflow-wrap: break-word;
            word-wrap: break-word;
            hyphens: auto;
        }
        
        .header-content h1,
        .header-content h2 {
            width: 100%;
            max-width: 100%;
            overflow-wrap: break-word;
            word-wrap: break-word;
            hyphens: auto;
            margin: 0;
            padding: 0;
        }
        
        /* Responsive grid adjustments - match main index.html */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 15px;
                width: 100%;
                max-width: 100%;
            }
        }
        
        /* Fix banner spacer styling */
        #bonjourarcade-banner-spacer {
            background: transparent !important;
            border: none !important;
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            display: block !important;
            max-width: 100vw !important;
            overflow: hidden !important;
        }
        
        /* Ensure banner doesn't cause visual artifacts */
        .bonjourarcade-banner {
            background: #3460e5 !important;
            border: none !important;
            margin: 0 !important;
            padding: 12px 0 !important;
            width: 100% !important;
            max-width: 100vw !important;
            overflow: hidden !important;
        }
        
        /* Container constraints */
        #header-container,
        .search-container,
        #header-content,
        #browser-warning,
        #gameGrid {
            width: 100% !important;
            max-width: 100% !important;
            overflow: hidden !important;
            box-sizing: border-box !important;
        }
        
        /* Hide tooltips on mobile devices */
        @media (max-width: 768px) {
            .game-meta-tooltip {
                display: none !important;
                opacity: 0 !important;
                visibility: hidden !important;
            }
        }
    </style>
    <style>
    .game-meta-tooltip {
        z-index: 9999 !important;
        position: fixed !important;
        pointer-events: none;
        background: rgba(24, 24, 24, 0.92) !important;
        color: #fff !important;
        border-radius: 10px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.28);
        padding: 18px 22px;
        min-width: 180px;
        max-width: 340px;
        font-size: 1.08em;
        font-family: inherit;
        opacity: 0.98;
        transition: opacity 0.15s;
    }
    .game-meta-table .meta-label {
        color: #fff !important;
    }
    .game-meta-table .meta-value {
        color: #fff !important;
    }
    </style>
</head>
<body>
    <div id="header-container" style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
        <button id="back-home-btn" style="padding: 0.6rem 1.2rem; font-size: 1rem; border-radius: 6px; border: none; background: #222; color: #fff; cursor: pointer; font-family: sans-serif; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">← Retour Accueil</button>
        
        <div id="header-buttons" style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
            <button id="theme-toggle" class="theme-toggle" style="margin-right: 0;">🌙</button>
            <button id="random-game-btn" class="random-game-btn">🎲 Jeu aléatoire (avec filtres)</button>
            <button id="screensaver-btn" class="screensaver-btn" style="padding: 0.6rem 1.2rem; font-size: 1rem; border-radius: 6px; border: none; background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: #fff; cursor: pointer; font-family: sans-serif; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">🔄 Mode écran de veille</button>
        </div>
    </div>
    
    <div class="search-container" style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <select id="search-type" style="padding: 0.75rem 0.5rem; border: 2px solid var(--border-color); border-radius: 8px 0 0 8px; font-size: 1rem; background: var(--card-bg); color: var(--text-color); border-right: none; cursor: pointer;">
            <option value="title">Titre</option>
            <option value="genre">Genre</option>
            <option value="developer">Développeur</option>
            <option value="system">Système</option>
            <option value="week">Jeux de la semaine</option>
            <option value="history">Historique</option>
        </select>
        <input type="text" id="search-input" class="search-input" placeholder="Rechercher par titre..." style="border-radius: 0 8px 8px 0; border-left: none; flex: 1; min-width: 200px;">
        <select id="genre-select" style="display: none; padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: 0 8px 8px 0; font-size: 1rem; background: var(--card-bg); color: var(--text-color); border-left: none; cursor: pointer;">
            <option value="">Sélectionner un genre...</option>
        </select>
        <select id="developer-select" style="display: none; padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: 0 8px 8px 0; font-size: 1rem; background: var(--card-bg); color: var(--text-color); border-left: none; cursor: pointer;">
            <option value="">Sélectionner un développeur...</option>
        </select>
        <select id="system-select" style="display: none; padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: 0 8px 8px 0; font-size: 1rem; background: var(--card-bg); color: var(--text-color); border-left: none; cursor: pointer;">
            <option value="">Sélectionner un système...</option>
        </select>
        <select id="sort-select" style="padding: 0.75rem 0.5rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; background: var(--card-bg); color: var(--text-color); cursor: pointer;">
            <option value="alpha">Trier: Alphabétique</option>
            <option value="latest">Trier: Derniers ajouts</option>
        </select>
        <span class="search-info" id="search-info"></span>
        <div class="filter-count" id="filter-count">1046 jeux</div>
    </div>
    
    <div id="header-content" class="header-content">
        <div class="header-left">
            <div>
                <h1>Tu as trouvé la cachette secrète de jeux!</h1>
                <h2>Lequel vas-tu essayer en premier?</h2>
            </div>
        </div>
    </div>

    <div id="browser-warning" class="browser-warning">
        <p><strong>Note :</strong> Pour une expérience de jeu optimale, nous vous recommandons d'utiliser un navigateur basé sur Chromium comme Google Chrome, Microsoft Edge ou Brave. Certains jeux peuvent ne pas fonctionner de manière optimale dans votre navigateur actuel.</p>
    </div>

    <div class="grid" id="gameGrid"></div>

    <script src="../assets/js/banner.js"></script>
    <script>
        // Store all games data globally
        let gamesData = [];
        let filteredGamesData = [];
        let predictionsData = [];
        let gameHistory = [];
        
        // Function to get current week number in YYYYWW format
        function getCurrentWeek() {
            const now = new Date();
            const year = now.getFullYear();
            const startOfYear = new Date(year, 0, 1);
            const days = Math.floor((now - startOfYear) / (24 * 60 * 60 * 1000));
            const weekNumber = Math.ceil((days + startOfYear.getDay() + 1) / 7);
            return year * 100 + weekNumber;
        }
        
        // Game history management functions
        function loadGameHistory() {
            try {
                const historyData = sessionStorage.getItem('gameHistory');
                if (historyData) {
                    gameHistory = JSON.parse(historyData);
                } else {
                    gameHistory = [];
                }
                return gameHistory;
            } catch (error) {
                console.error('Error loading game history:', error);
                gameHistory = [];
                return gameHistory;
            }
        }
        
        function saveGameHistory() {
            try {
                sessionStorage.setItem('gameHistory', JSON.stringify(gameHistory));
            } catch (error) {
                console.error('Error saving game history:', error);
            }
        }
        
        function addGameToHistory(gameId) {
            if (!gameId) return;
            
            // Remove if already exists to avoid duplicates
            gameHistory = gameHistory.filter(entry => entry.gameId !== gameId);
            
            // Add to beginning of array (most recent first)
            gameHistory.unshift({
                gameId: gameId,
                timestamp: Date.now(),
                date: new Date().toISOString()
            });
            
            // Keep only last 50 games to avoid storage bloat
            if (gameHistory.length > 50) {
                gameHistory = gameHistory.slice(0, 50);
            }
            
            saveGameHistory();
        }
        
        function getHistoryGameIds() {
            // Always load fresh data from sessionStorage
            const freshHistory = loadGameHistory();
            // Ensure we have an array before calling map
            if (!Array.isArray(freshHistory)) {
                console.warn('History data is not an array:', freshHistory);
                return [];
            }
            return freshHistory.map(entry => entry.gameId);
        }
        
        // Back to home button
        document.getElementById('back-home-btn').addEventListener('click', function() {
            window.location.href = '../index.html';
        });
        
        // Function to scroll to a specific game
        function scrollToGame(gameId) {
            if (!gameId) return;
            
            // Wait for games to be rendered
            setTimeout(() => {
                // Find the game element by its link href
                const gameLink = document.querySelector(`a[href="../play?game=${gameId}"]`);
                if (gameLink) {
                    const gameElement = gameLink.closest('.game');
                    if (gameElement) {
                        // Jump to the game instantly
                        gameElement.scrollIntoView({ 
                            behavior: 'auto', 
                            block: 'center' 
                        });
                        
                        // Add a prominent animation effect
                        gameElement.style.backgroundColor = 'rgba(76, 175, 80, 0.15)';
                        gameElement.style.boxShadow = '0 0 25px rgba(76, 175, 80, 0.5), 0 0 50px rgba(76, 175, 80, 0.3)';
                        gameElement.style.transform = 'scale(1.05)';
                        gameElement.style.transition = 'background-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease';
                        
                        // Add a pulsing animation
                        let pulseCount = 0;
                        const maxPulses = 3;
                        const pulseInterval = setInterval(() => {
                            pulseCount++;
                            if (pulseCount <= maxPulses) {
                                // Pulse effect
                                gameElement.style.transform = 'scale(1.08)';
                                gameElement.style.boxShadow = '0 0 35px rgba(76, 175, 80, 0.7), 0 0 70px rgba(76, 175, 80, 0.4)';
                                
                                setTimeout(() => {
                                    gameElement.style.transform = 'scale(1.05)';
                                    gameElement.style.boxShadow = '0 0 25px rgba(76, 175, 80, 0.5), 0 0 50px rgba(76, 175, 80, 0.3)';
                                }, 300);
                            } else {
                                clearInterval(pulseInterval);
                                // Final fade out
                                setTimeout(() => {
                                    gameElement.style.backgroundColor = '';
                                    gameElement.style.boxShadow = '';
                                    gameElement.style.transform = '';
                                }, 1000);
                            }
                        }, 600);
                    }
                }
            }, 100);
        }
        
        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('theme-dark');
                document.getElementById('theme-toggle').textContent = '☀️';
            } else {
                document.body.classList.remove('theme-dark');
                document.getElementById('theme-toggle').textContent = '🌙';
            }
        }

        function toggleTheme() {
            const body = document.body;
            const toggle = document.getElementById('theme-toggle');
            
            if (body.classList.contains('theme-dark')) {
                body.classList.remove('theme-dark');
                localStorage.setItem('theme', 'light');
                toggle.textContent = '🌙';
            } else {
                body.classList.add('theme-dark');
                localStorage.setItem('theme', 'dark');
                toggle.textContent = '☀️';
            }
        }

        // Utility function to remove accents from text
        function removeAccents(text) {
            if (!text) return '';
            return text.normalize('NFD')
                       .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                       .toLowerCase();
        }

        // Search functionality
        function filterGames(searchTerm) {
            const searchType = document.getElementById('search-type').value;
            
            if (!searchTerm && searchType !== 'week' && searchType !== 'history') {
                filteredGamesData = gamesData;
                updateSearchInfo();
                renderGames(filteredGamesData);
                showHeaderElements(); // Show header elements when search is cleared
                showSectionHeaders(); // Show section headers when search is cleared
                return;
            }
            
            // Handle week games filter
            if (searchType === 'week') {
                const currentWeek = getCurrentWeek();
                
                // Filter games that are in predictions and not from future weeks
                filteredGamesData = gamesData.filter(game => {
                    const prediction = predictionsData.find(pred => pred.game_id === game.id);
                    if (!prediction) return false;
                    
                    // Only include games from current week or earlier
                    const weekNumber = parseInt(prediction.week);
                    return weekNumber <= currentWeek;
                });
                
                // Sort by seed number (week number) in descending order (latest first)
                filteredGamesData.sort((a, b) => {
                    const aPrediction = predictionsData.find(pred => pred.game_id === a.id);
                    const bPrediction = predictionsData.find(pred => pred.game_id === b.id);
                    
                    if (!aPrediction || !bPrediction) return 0;
                    
                    const aWeek = parseInt(aPrediction.week);
                    const bWeek = parseInt(bPrediction.week);
                    
                    return bWeek - aWeek; // Descending order (latest first)
                });
                
                updateSearchInfo();
                renderGames(filteredGamesData);
                hideHeaderElements(); // Hide header elements when filtering
                hideSectionHeaders(); // Hide section headers when filtering
                return;
            }
            
            // Handle history filter
            if (searchType === 'history') {
                const historyGameIds = getHistoryGameIds();
                
                // Filter games that are in the history
                filteredGamesData = gamesData.filter(game => {
                    return historyGameIds.includes(game.id);
                });
                
                // If no games in history, show a message
                if (filteredGamesData.length === 0) {
                    const container = document.getElementById('gameGrid');
                    container.innerHTML = '<div class="no-results">Aucun jeu dans votre historique. Lancez quelques jeux pour les voir apparaître ici !</div>';
                    hideHeaderElements();
                    hideSectionHeaders();
                    return;
                }
                
                // Sort by history order (most recent first)
                filteredGamesData.sort((a, b) => {
                    const aIndex = historyGameIds.indexOf(a.id);
                    const bIndex = historyGameIds.indexOf(b.id);
                    return aIndex - bIndex; // Ascending order (most recent first)
                });
                
                updateSearchInfo();
                renderGames(filteredGamesData);
                hideHeaderElements(); // Hide header elements when filtering
                hideSectionHeaders(); // Hide section headers when filtering
                return;
            }
            
            const term = searchTerm.toLowerCase();
            
            // Filter based on search type
            filteredGamesData = gamesData.filter(game => {
                if (searchType === 'title') {
                    // Search only by title
                    let displayTitle = getDisplayTitle(game);
                    // Use accent-insensitive search
                    return removeAccents(displayTitle).includes(removeAccents(term));
                } else if (searchType === 'genre') {
                    // Search only by genre (exact match from dropdown, case insensitive)
                    // Check if any of the comma-separated genres match
                    if (game.genre) {
                        const individualGenres = game.genre.split(',').map(g => g.trim().toLowerCase());
                        return individualGenres.includes(term.toLowerCase());
                    }
                    return false;
                } else if (searchType === 'developer') {
                    // Search only by developer (exact match from dropdown, case insensitive)
                    // Check if any of the comma-separated developers match
                    if (game.developer) {
                        const individualDevelopers = game.developer.split(',').map(d => d.trim().toLowerCase());
                        return individualDevelopers.includes(term.toLowerCase());
                    }
                    return false;
                } else if (searchType === 'system') {
                    // Search only by system (exact match from dropdown, case insensitive)
                    if (game.core) {
                        const systemName = getSystemName(game.core);
                        return systemName.toLowerCase() === term.toLowerCase();
                    }
                    return false;
                }
                return false;
            });
            
            updateSearchInfo();
            renderGames(filteredGamesData);
            hideHeaderElements(); // Hide header elements when searching
            hideSectionHeaders(); // Hide section headers when searching
        }
        
        function showHeaderElements() {
            const headerContainer = document.getElementById('header-container');
            const headerContent = document.getElementById('header-content');
            if (headerContainer) headerContainer.style.display = 'flex';
            if (headerContent) headerContent.style.display = 'block';
        }
        
        function hideHeaderElements() {
            const headerContainer = document.getElementById('header-container');
            const headerContent = document.getElementById('header-content');
            // Keep header container visible (contains back button, search, theme toggle, random button)
            // Only hide the header content (title text)
            if (headerContent) headerContent.style.display = 'none';
        }
        
        function showSectionHeaders() {
            const sectionHeaders = document.querySelectorAll('.section-header');
            sectionHeaders.forEach(header => {
                header.style.display = 'block';
            });
        }
        
        function hideSectionHeaders() {
            const sectionHeaders = document.querySelectorAll('.section-header');
            sectionHeaders.forEach(header => {
                header.style.display = 'none';
            });
        }
        
        function updateSearchInfo() {
            const searchInfo = document.getElementById('search-info');
            const filterCount = document.getElementById('filter-count');
            
            if (filteredGamesData.length === gamesData.length) {
                // No active filters - show total count in filter-count, hide search-info
                searchInfo.textContent = '';
                filterCount.textContent = `${filteredGamesData.length} jeux`;
                filterCount.style.display = 'block';
            } else {
                // Active filters - show detailed message in search-info, hide filter-count
                searchInfo.textContent = `${filteredGamesData.length} jeu${filteredGamesData.length > 1 ? 'x' : ''} trouvé${filteredGamesData.length > 1 ? 's' : ''}`;
                filterCount.style.display = 'none';
            }
        }
        
        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        function getDisplayTitle(game) {
            let displayTitle = game.title;
            if (!displayTitle || displayTitle === game.id) {
                displayTitle = capitalizeFirst(game.id);
            }
            
            // Add problem indicator if the game has problems
            if (game.problem === "true") {
                displayTitle += ' (❌)';
            }
            
            return displayTitle;
        }
        
        function renderGames(games) {
            const container = document.getElementById('gameGrid');
            container.innerHTML = '';
            
            if (games.length === 0) {
                container.innerHTML = '<div class="no-results">Aucun jeu ne correspond à votre recherche</div>';
                return;
            }
            
            // Check if we're in search mode (no sections when searching)
            const searchInput = document.getElementById('search-input');
            const genreSelect = document.getElementById('genre-select');
            const developerSelect = document.getElementById('developer-select');
            const systemSelect = document.getElementById('system-select');
            const sortSelect = document.getElementById('sort-select');
            const searchType = document.getElementById('search-type').value;
            const isSearching = (searchInput && searchInput.value) || (genreSelect && genreSelect.value) || (developerSelect && developerSelect.value) || (systemSelect && systemSelect.value) || (searchType === 'week') || (searchType === 'history');
            
            if (isSearching) {
                // Simple grid layout for search results (no sections)
                const searchGrid = document.createElement('div');
                searchGrid.className = 'section-games';
                searchGrid.style.width = '100%';
                searchGrid.style.display = 'grid';
                
                // Responsive grid template columns
                if (window.innerWidth <= 768) {
                    searchGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
                    searchGrid.style.gap = '12px';
                    searchGrid.style.marginBottom = '0.3rem';
                } else if (window.innerWidth >= 1200) {
                    searchGrid.style.gridTemplateColumns = 'repeat(7, 1fr)';
                    searchGrid.style.gap = '1.2rem';
                    searchGrid.style.marginBottom = '0.5rem';
                } else {
                    searchGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(150px, 1fr))';
                    searchGrid.style.gap = '1.2rem';
                    searchGrid.style.marginBottom = '0.5rem';
                }
                
                // Sort games based on search type and sort selection
                if (searchType === 'week') {
                    // Sort week games by seed number (week number) in descending order (latest first)
                    games.sort((a, b) => {
                        const aPrediction = predictionsData.find(pred => pred.game_id === a.id);
                        const bPrediction = predictionsData.find(pred => pred.game_id === b.id);
                        
                        if (!aPrediction || !bPrediction) return 0;
                        
                        const aWeek = parseInt(aPrediction.week);
                        const bWeek = parseInt(bPrediction.week);
                        
                        return bWeek - aWeek; // Descending order (latest first)
                    });
                } else {
                    if (sortSelect && sortSelect.value === 'latest') {
                        // Sort by added date (newest first)
                        games.sort((a, b) => {
                            if (a.added && b.added) {
                                const dateA = new Date(a.added);
                                const dateB = new Date(b.added);
                                return dateB - dateA;
                            }
                            if (a.added && !b.added) return -1;
                            if (!a.added && b.added) return 1;
                            let titleA = a.title;
                            let titleB = b.title;
                            if (!titleA || titleA === a.id) titleA = capitalizeFirst(a.id);
                            if (!titleB || titleB === b.id) titleB = capitalizeFirst(b.id);
                            return titleA.localeCompare(titleB);
                        });
                    } else {
                        // Default alphabetical
                        games.sort((a, b) => {
                            let titleA = a.title;
                            let titleB = b.title;
                            if (!titleA || titleA === a.id) titleA = capitalizeFirst(a.id);
                            if (!titleB || titleB === b.id) titleB = capitalizeFirst(b.id);
                            return titleA.localeCompare(titleB);
                        });
                    }
                }
                
                // Render all games in the search grid
                games.forEach(game => {
                    const div = document.createElement('div');
                    div.className = 'game';
                    div._gameData = game;

                    let coverSrc = game.coverArt || '/assets/images/placeholder_thumb.png';

                    // Use thumbnail version if available
                    if (coverSrc && coverSrc !== '/assets/images/placeholder_thumb.png') {
                        const lastDotIndex = coverSrc.lastIndexOf('.');
                        if (lastDotIndex !== -1) {
                            coverSrc = coverSrc.substring(0, lastDotIndex) + '_thumb' + coverSrc.substring(lastDotIndex);
                        }
                    }

                    // Add special border and badge if new_flag is true
                    if (game.new_flag === 'true') {
                        div.classList.add('game-new');
                    }

                    div.innerHTML = `
                        <a href="${game.pageUrl}" class="game-link">
                            <div class="game-cover" style="position:relative;">
                                ${game.new_flag === 'true' ? '<span class="new-badge">NOUVEAU</span>' : ''}
                                <img src="${coverSrc}" alt="${game.title}">
                            </div>
                            <div class="game-title">${getDisplayTitle(game)}</div>
                        </a>
                    `;
                    
                    // Add click handler to set referrer flag and store game ID for back navigation
                    div.querySelector('a').addEventListener('click', function(e) {
                        sessionStorage.setItem('referrerAllGames', '1');
                        sessionStorage.setItem('lastPlayedGame', game.id);
                        addGameToHistory(game.id);
                    });

                    // Tooltip event listeners - only on non-mobile devices
                    if (!isMobileDevice()) {
                        div.addEventListener('mouseenter', (e) => {
                            showTooltipForItem(div);
                        });
                        div.addEventListener('mouseleave', (e) => {
                            removeTooltip();
                        });
                    }

                    searchGrid.appendChild(div);
                });
                
                container.appendChild(searchGrid);
            } else {
                // Original sectioned layout for browsing (when not searching)
                // If sorting by latest, render a single grid of all games by added date
                if (sortSelect && sortSelect.value === 'latest') {
                    const searchGrid = document.createElement('div');
                    searchGrid.className = 'section-games';
                    searchGrid.style.width = '100%';
                    searchGrid.style.display = 'grid';
                    if (window.innerWidth <= 768) {
                        searchGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
                        searchGrid.style.gap = '12px';
                        searchGrid.style.marginBottom = '0.3rem';
                    } else if (window.innerWidth >= 1200) {
                        searchGrid.style.gridTemplateColumns = 'repeat(7, 1fr)';
                        searchGrid.style.gap = '1.2rem';
                        searchGrid.style.marginBottom = '0.5rem';
                    } else {
                        searchGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(150px, 1fr))';
                        searchGrid.style.gap = '1.2rem';
                        searchGrid.style.marginBottom = '0.5rem';
                    }

                    const sorted = [...games].sort((a, b) => {
                        if (a.added && b.added) {
                            const dateA = new Date(a.added);
                            const dateB = new Date(b.added);
                            return dateB - dateA;
                        }
                        if (a.added && !b.added) return -1;
                        if (!a.added && b.added) return 1;
                        let titleA = getDisplayTitle(a);
                        let titleB = getDisplayTitle(b);
                        return titleA.localeCompare(titleB);
                    });

                    sorted.forEach(game => {
                        const div = document.createElement('div');
                        div.className = 'game';
                        div._gameData = game;
                        let coverSrc = game.coverArt || '/assets/images/placeholder_thumb.png';
                        if (coverSrc && coverSrc !== '/assets/images/placeholder_thumb.png') {
                            const lastDotIndex = coverSrc.lastIndexOf('.');
                            if (lastDotIndex !== -1) {
                                coverSrc = coverSrc.substring(0, lastDotIndex) + '_thumb' + coverSrc.substring(lastDotIndex);
                            }
                        }
                        if (game.new_flag === 'true') {
                            div.classList.add('game-new');
                        }
                        div.innerHTML = `
                            <a href="${game.pageUrl}" class="game-link">
                                <div class="game-cover" style="position:relative;">
                                    ${game.new_flag === 'true' ? '<span class="new-badge">NOUVEAU</span>' : ''}
                                    <img src="${coverSrc}" alt="${game.title}">
                                </div>
                                <div class="game-title">${getDisplayTitle(game)}</div>
                            </a>
                        `;
                        div.querySelector('a').addEventListener('click', function(e) {
                            sessionStorage.setItem('referrerAllGames', '1');
                            sessionStorage.setItem('lastPlayedGame', game.id);
                            addGameToHistory(game.id);
                        });
                        if (!isMobileDevice()) {
                            div.addEventListener('mouseenter', (e) => {
                                showTooltipForItem(div);
                            });
                            div.addEventListener('mouseleave', (e) => {
                                removeTooltip();
                            });
                        }
                        searchGrid.appendChild(div);
                    });

                    container.appendChild(searchGrid);
                    return;
                }
                // Group games by first letter
                const gamesByLetter = {};
                games.forEach(game => {
                    let displayTitle = getDisplayTitle(game);
                    const firstChar = displayTitle.charAt(0).toUpperCase();
                    
                    // Group numbers into "#" category
                    let category = firstChar;
                    if (/[0-9]/.test(firstChar)) {
                        category = '#';
                    }
                    
                    if (!gamesByLetter[category]) {
                        gamesByLetter[category] = [];
                    }
                    gamesByLetter[category].push(game);
                });
                
                // Sort letters alphabetically, but put "#" at the beginning
                const sortedLetters = Object.keys(gamesByLetter).sort((a, b) => {
                    if (a === '#') return -1;
                    if (b === '#') return 1;
                    return a.localeCompare(b);
                });
                
                // Render each section
                sortedLetters.forEach(letter => {
                    // Create section header
                    const sectionHeader = document.createElement('div');
                    sectionHeader.className = 'section-header';
                    sectionHeader.innerHTML = `<h2>${letter}</h2>`;
                    container.appendChild(sectionHeader);
                    
                    // Create section container with full width
                    const sectionContainer = document.createElement('div');
                    sectionContainer.className = 'section-games';
                    sectionContainer.style.width = '100%';
                    sectionContainer.style.display = 'grid';
                    
                    // Responsive grid template columns
                    if (window.innerWidth <= 768) {
                        sectionContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
                        sectionContainer.style.gap = '12px';
                        sectionContainer.style.marginBottom = '0.3rem';
                    } else if (window.innerWidth >= 1200) {
                        sectionContainer.style.gridTemplateColumns = 'repeat(7, 1fr)';
                        sectionContainer.style.gap = '1.2rem';
                        sectionContainer.style.marginBottom = '0.5rem';
                    } else {
                        sectionContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(150px, 1fr))';
                        sectionContainer.style.gap = '1.2rem';
                        sectionContainer.style.marginBottom = '0.5rem';
                    }
                    
                    // Sort games within each section alphabetically
                    gamesByLetter[letter].sort((a, b) => {
                        let titleA = getDisplayTitle(a);
                        let titleB = getDisplayTitle(b);
                        return titleA.localeCompare(titleB);
                    });
                    
                    // Render games in this section
                    gamesByLetter[letter].forEach(game => {
                        const div = document.createElement('div');
                        div.className = 'game';
                        div._gameData = game;

                        let coverSrc = game.coverArt || '/assets/images/placeholder_thumb.png';

                        // Use thumbnail version if available
                        if (coverSrc && coverSrc !== '/assets/images/placeholder_thumb.png') {
                            const lastDotIndex = coverSrc.lastIndexOf('.');
                            if (lastDotIndex !== -1) {
                                coverSrc = coverSrc.substring(0, lastDotIndex) + '_thumb' + coverSrc.substring(lastDotIndex);
                            }
                        }

                        // Add special border and badge if new_flag is true
                        if (game.new_flag === 'true') {
                            div.classList.add('game-new');
                        }

                        div.innerHTML = `
                            <a href="${game.pageUrl}" class="game-link">
                                <div class="game-cover" style="position:relative;">
                                    ${game.new_flag === 'true' ? '<span class="new-badge">NOUVEAU</span>' : ''}
                                    <img src="${coverSrc}" alt="${game.title}">
                                </div>
                                <div class="game-title">${getDisplayTitle(game)}</div>
                            </a>
                        `;
                        
                        // Add click handler to set referrer flag and store game ID for back navigation
                        div.querySelector('a').addEventListener('click', function(e) {
                            sessionStorage.setItem('referrerAllGames', '1');
                            sessionStorage.setItem('lastPlayedGame', game.id);
                            addGameToHistory(game.id);
                        });

                        // Tooltip event listeners - only on non-mobile devices
                        if (!isMobileDevice()) {
                            div.addEventListener('mouseenter', (e) => {
                                showTooltipForItem(div);
                            });
                            div.addEventListener('mouseleave', (e) => {
                                removeTooltip();
                            });
                        }

                        sectionContainer.appendChild(div);
                    });
                    
                    container.appendChild(sectionContainer);
                });
            }
        }

        // Function to select a random game from the list
        function playRandomGame() {
            // Use filtered games if available, otherwise fall back to all games
            const gamesToRandomizeFrom = filteredGamesData.length > 0 ? filteredGamesData : gamesData;
            
            if (gamesToRandomizeFrom.length > 0) {
                const randomIndex = Math.floor(Math.random() * gamesToRandomizeFrom.length);
                const randomGame = gamesToRandomizeFrom[randomIndex];
                sessionStorage.setItem('referrerAllGames', '1');
                sessionStorage.setItem('lastPlayedGame', randomGame.id);
                window.location.href = randomGame.pageUrl;
            } else {
                // Show a message if no games match the current filters
                alert('Aucun jeu ne correspond à vos filtres actuels pour la sélection aléatoire.');
            }
        }
        

        // Check if device is mobile
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   window.innerWidth <= 768;
        }

        // Focus search function
        function focusSearch() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
            }
        }

        // Detect if browser is Chromium-based
        function isChromiumBased() {
            const userAgent = navigator.userAgent.toLowerCase();
            return userAgent.includes('chrome') ||
                   userAgent.includes('chromium') ||
                   userAgent.includes('edg') ||
                   userAgent.includes('brave');
        }

        // Check browser and show warning if needed
        function checkBrowser() {
            if (!isChromiumBased()) {
                document.getElementById('browser-warning').style.display = 'block';
            }
        }

        // Add event listeners
        document.getElementById('random-game-btn').addEventListener('click', playRandomGame);
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        document.getElementById('screensaver-btn').addEventListener('click', function() {
            window.location.href = '/screensaver/';
        });
        
        // Search input event listener
        document.getElementById('search-input').addEventListener('input', (e) => {
            filterGames(e.target.value);
        });
        
        // Search type dropdown event listener
        document.getElementById('search-type').addEventListener('change', (e) => {
            const searchInput = document.getElementById('search-input');
            const genreSelect = document.getElementById('genre-select');
            const developerSelect = document.getElementById('developer-select');
            const systemSelect = document.getElementById('system-select');
            const searchType = e.target.value;
            
            // Update placeholder text and show/hide appropriate input
            if (searchType === 'title') {
                searchInput.placeholder = 'Rechercher par titre...';
                searchInput.style.display = 'block';
                genreSelect.style.display = 'none';
                developerSelect.style.display = 'none';
                systemSelect.style.display = 'none';
                searchInput.value = '';
                genreSelect.value = '';
                developerSelect.value = '';
                systemSelect.value = '';
            } else if (searchType === 'history') {
                searchInput.placeholder = 'Historique des jeux joués...';
                searchInput.style.display = 'none';
                genreSelect.style.display = 'none';
                developerSelect.style.display = 'none';
                systemSelect.style.display = 'none';
                searchInput.value = '';
                genreSelect.value = '';
                developerSelect.value = '';
                systemSelect.value = '';
            } else if (searchType === 'genre') {
                searchInput.style.display = 'none';
                genreSelect.style.display = 'block';
                developerSelect.style.display = 'none';
                systemSelect.style.display = 'none';
                searchInput.value = '';
                genreSelect.value = '';
                developerSelect.value = '';
                systemSelect.value = '';
                
                // Populate genre select with unique genres from gamesData (case-insensitive deduplication and comma splitting)
                const genreMap = new Map();
                gamesData.forEach(game => {
                    if (game.genre) {
                        // Split genres by comma and trim whitespace
                        const individualGenres = game.genre.split(',').map(g => g.trim());
                        individualGenres.forEach(subGenre => {
                            if (subGenre) { // Ensure subGenre is not empty after trimming
                                const lowerSubGenre = subGenre.toLowerCase();
                                if (!genreMap.has(lowerSubGenre)) {
                                    genreMap.set(lowerSubGenre, subGenre); // Keep original case for display
                                }
                            }
                        });
                    }
                });
                const uniqueGenres = Array.from(genreMap.values()).sort();
                genreSelect.innerHTML = '<option value="">Sélectionner un genre...</option>';
                uniqueGenres.forEach(genre => {
                    const option = document.createElement('option');
                    option.value = genre;
                    option.textContent = genre;
                    genreSelect.appendChild(option);
                });
            } else if (searchType === 'developer') {
                searchInput.style.display = 'none';
                genreSelect.style.display = 'none';
                developerSelect.style.display = 'block';
                systemSelect.style.display = 'none';
                searchInput.value = '';
                genreSelect.value = '';
                developerSelect.value = '';
                systemSelect.value = '';
                
                // Populate developer select with unique developers from gamesData (case-insensitive deduplication and comma splitting)
                const developerMap = new Map();
                gamesData.forEach(game => {
                    if (game.developer) {
                        // Split developers by comma and trim whitespace
                        const individualDevelopers = game.developer.split(',').map(d => d.trim());
                        individualDevelopers.forEach(subDeveloper => {
                            if (subDeveloper) { // Ensure subDeveloper is not empty after trimming
                                const lowerSubDeveloper = subDeveloper.toLowerCase();
                                if (!developerMap.has(lowerSubDeveloper)) {
                                    developerMap.set(lowerSubDeveloper, subDeveloper); // Keep original case for display
                                }
                            }
                        });
                    }
                });
                const uniqueDevelopers = Array.from(developerMap.values()).sort();
                developerSelect.innerHTML = '<option value="">Sélectionner un développeur...</option>';
                uniqueDevelopers.forEach(developer => {
                    const option = document.createElement('option');
                    option.value = developer;
                    option.textContent = developer;
                    developerSelect.appendChild(option);
                });
            } else if (searchType === 'system') {
                searchInput.style.display = 'none';
                genreSelect.style.display = 'none';
                developerSelect.style.display = 'none';
                systemSelect.style.display = 'block';
                searchInput.value = '';
                genreSelect.value = '';
                developerSelect.value = '';
                systemSelect.value = '';
                
                // Populate system select with unique systems from gamesData
                const systemMap = new Map();
                gamesData.forEach(game => {
                    if (game.core) {
                        const systemName = getSystemName(game.core);
                        if (systemName) {
                            const lowerSystemName = systemName.toLowerCase();
                            if (!systemMap.has(lowerSystemName)) {
                                systemMap.set(lowerSystemName, systemName);
                            }
                        }
                    }
                });
                const uniqueSystems = Array.from(systemMap.values()).sort();
                systemSelect.innerHTML = '<option value="">Sélectionner un système...</option>';
                uniqueSystems.forEach(system => {
                    const option = document.createElement('option');
                    option.value = system;
                    option.textContent = system;
                    systemSelect.appendChild(option);
                });
            } else if (searchType === 'week') {
                searchInput.style.display = 'none';
                genreSelect.style.display = 'none';
                developerSelect.style.display = 'none';
                systemSelect.style.display = 'none';
                searchInput.value = '';
                genreSelect.value = '';
                developerSelect.value = '';
                systemSelect.value = '';
                
                // Trigger week games filter
                filterGames('');
                return;
            } else if (searchType === 'history') {
                searchInput.style.display = 'none';
                genreSelect.style.display = 'none';
                developerSelect.style.display = 'none';
                systemSelect.style.display = 'none';
                searchInput.value = '';
                genreSelect.value = '';
                developerSelect.value = '';
                systemSelect.value = '';
                
                // Trigger history filter
                filterGames('');
                return;
            }
            
            // Clear any existing search results
            filterGames('');
        });
        
        // Genre select event listener
        document.getElementById('genre-select').addEventListener('change', (e) => {
            // Ensure search type is set to 'genre' when filtering by genre
            if (e.target.value) {
                document.getElementById('search-type').value = 'genre';
            }
            filterGames(e.target.value);
        });

        // Developer select event listener
        document.getElementById('developer-select').addEventListener('change', (e) => {
            // Ensure search type is set to 'developer' when filtering by developer
            if (e.target.value) {
                document.getElementById('search-type').value = 'developer';
            }
            filterGames(e.target.value);
        });

        // System select event listener
        document.getElementById('system-select').addEventListener('change', (e) => {
            // Ensure search type is set to 'system' when filtering by system
            if (e.target.value) {
                document.getElementById('search-type').value = 'system';
            }
            filterGames(e.target.value);
        });

        // Sort select event listener
        document.getElementById('sort-select').addEventListener('change', () => {
            const current = (filteredGamesData.length > 0 || document.getElementById('search-input').value || document.getElementById('genre-select').value || document.getElementById('developer-select').value || document.getElementById('system-select').value || document.getElementById('search-type').value === 'week')
                ? filteredGamesData
                : gamesData;
            renderGames(current);
        });


        // Keyboard event listener for "/" key and arrow keys
        document.addEventListener('keydown', function(e) {
            // If search is focused, handle Escape key
            if (document.activeElement === document.getElementById('search-input')) {
                if (e.key === 'Escape') {
                    const searchInput = document.getElementById('search-input');
                    searchInput.value = '';
                    searchInput.blur();
                    filterGames('');
                    e.preventDefault();
                }
                return;
            }
            
            // Handle arrow key scrolling
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                const scrollAmount = 300; // Pixels to scroll (increased by 4x)
                const currentScrollY = window.scrollY;
                
                if (e.key === 'ArrowUp') {
                    // Scroll up
                    window.scrollTo({
                        top: Math.max(0, currentScrollY - scrollAmount),
                        behavior: 'smooth'
                    });
                } else if (e.key === 'ArrowDown') {
                    // Scroll down
                    window.scrollTo({
                        top: currentScrollY + scrollAmount,
                        behavior: 'smooth'
                    });
                }
                
                e.preventDefault();
                return;
            }
            
            // Focus search bar on "/" key
            if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                focusSearch();
                e.preventDefault();
            }
            
            // Jump to section on letter key press
            if (!e.ctrlKey && !e.metaKey && !e.altKey && !e.shiftKey) {
                const key = e.key.toLowerCase();
                
                // Check if it's a letter (a-z) or number (0-9)
                if ((key >= 'a' && key <= 'z') || (key >= '0' && key <= '9')) {
                    jumpToSection(key);
                    e.preventDefault();
                }
            }
        });
        
        // Function to jump to a specific section
        function jumpToSection(letter) {
            // Convert number to '#' for number section
            const sectionLetter = /[0-9]/.test(letter) ? '#' : letter.toUpperCase();
            
            // Find the section header
            const sectionHeaders = document.querySelectorAll('.section-header h2');
            let targetSection = null;
            let targetSectionContainer = null;
            
            sectionHeaders.forEach(header => {
                if (header.textContent === sectionLetter) {
                    targetSection = header.closest('.section-header');
                    // Find the next sibling which should be the section-games container
                    targetSectionContainer = targetSection.nextElementSibling;
                }
            });
            
            if (targetSection) {
                // Scroll to the section with smooth animation
                targetSection.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
                
                // Clear any existing highlights
                document.querySelectorAll('.section-header').forEach(header => {
                    header.style.backgroundColor = '';
                    header.style.boxShadow = '';
                });
                document.querySelectorAll('.section-games').forEach(container => {
                    container.style.backgroundColor = '';
                    container.style.boxShadow = '';
                });
                document.querySelectorAll('.game').forEach(game => {
                    game.style.backgroundColor = '';
                    game.style.boxShadow = '';
                    game.style.transform = '';
                });
                
                // Add a prominent highlight effect to the section header
                targetSection.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
                targetSection.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.3)';
                targetSection.style.transition = 'background-color 0.3s ease, box-shadow 0.3s ease';
                
                // Also highlight the section title
                const sectionTitle = targetSection.querySelector('h2');
                if (sectionTitle) {
                    sectionTitle.style.color = '#2e7d32';
                    sectionTitle.style.textShadow = '0 0 10px rgba(46, 125, 50, 0.5)';
                    sectionTitle.style.transition = 'color 0.3s ease, text-shadow 0.3s ease';
                }
                
                // Highlight the section games container
                if (targetSectionContainer && targetSectionContainer.classList.contains('section-games')) {
                    targetSectionContainer.style.backgroundColor = 'rgba(76, 175, 80, 0.05)';
                    targetSectionContainer.style.boxShadow = 'inset 0 0 20px rgba(76, 175, 80, 0.1)';
                    targetSectionContainer.style.transition = 'background-color 0.3s ease, box-shadow 0.3s ease';
                    
                    // Highlight each game in the section
                    const games = targetSectionContainer.querySelectorAll('.game');
                    games.forEach((game, index) => {
                        // Stagger the animation for a wave effect
                        setTimeout(() => {
                            game.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                            game.style.boxShadow = '0 0 15px rgba(76, 175, 80, 0.2)';
                            game.style.transform = 'scale(1.02)';
                            game.style.transition = 'background-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease';
                        }, index * 50); // 50ms delay between each game
                    });
                }
                
                setTimeout(() => {
                    // Remove highlights from section header
                    targetSection.style.backgroundColor = '';
                    targetSection.style.boxShadow = '';
                    if (sectionTitle) {
                        sectionTitle.style.color = '';
                        sectionTitle.style.textShadow = '';
                    }
                    
                    // Remove highlights from section games container
                    if (targetSectionContainer && targetSectionContainer.classList.contains('section-games')) {
                        targetSectionContainer.style.backgroundColor = '';
                        targetSectionContainer.style.boxShadow = '';
                        
                        // Remove highlights from each game
                        const games = targetSectionContainer.querySelectorAll('.game');
                        games.forEach((game, index) => {
                            setTimeout(() => {
                                game.style.backgroundColor = '';
                                game.style.boxShadow = '';
                                game.style.transform = '';
                            }, index * 30); // Faster removal
                        });
                    }
                }, 1500);
            }
        }

        // Initialize theme and check browser when page loads
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            checkBrowser();
            loadGameHistory();
            
            // Check if we should scroll to a specific game (from URL parameter or session storage)
            const urlParams = new URLSearchParams(window.location.search);
            let scrollToGameId = urlParams.get('scrollTo');
            
            // If no URL parameter, check session storage for last played game
            if (!scrollToGameId) {
                scrollToGameId = sessionStorage.getItem('lastPlayedGame');
                if (scrollToGameId) {
                    // Clear the stored game ID
                    sessionStorage.removeItem('lastPlayedGame');
                }
            }
            
            if (scrollToGameId) {
                // Remove the parameter from URL without reloading
                urlParams.delete('scrollTo');
                const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                window.history.replaceState({}, '', newUrl);
                
                // Scroll to the game after games are loaded
                setTimeout(() => {
                    scrollToGame(scrollToGameId);
                }, 500);
            }
        });

        // Fetch predictions data
        fetch('/plinko/predict/predictions.yaml')
            .then(res => res.text())
            .then(yamlText => {
                // Parse YAML data (simple parsing for this specific format)
                const lines = yamlText.split('\n');
                const predictions = [];
                let currentPrediction = null;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Check if line is a week key (format: YYYYWW: )
                    if (/^\d{6}: $/.test(line)) {
                        if (currentPrediction) {
                            predictions.push(currentPrediction);
                        }
                        currentPrediction = {
                            week: line.replace(': ', ''),
                            title: '',
                            game_id: ''
                        };
                    } else if (currentPrediction && line.startsWith('  title: ')) {
                        currentPrediction.title = line.replace('  title: ', '').replace(/"/g, '');
                    } else if (currentPrediction && line.startsWith('  game_id: ')) {
                        currentPrediction.game_id = line.replace('  game_id: ', '').replace(/"/g, '');
                    }
                }
                
                // Add the last prediction
                if (currentPrediction) {
                    predictions.push(currentPrediction);
                }
                
                // Store predictions data (already in chronological order from latest to oldest)
                predictionsData = predictions;
            })
            .catch(err => {
                console.error('Error loading predictions.yaml:', err);
                predictionsData = [];
            });

        // Fetch and render games
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const gamelistUrl = isLocalhost ? '../gamelist.json' : 'https://storage.googleapis.com/bonjourarcade-roms/gamelist.json';
        fetch(gamelistUrl)
            .then(res => res.json())
            .then(data => {
                // Use all games from the simplified structure
                gamesData = Array.isArray(data.games) ? data.games : [];
                
                // Filter out games with problems
                gamesData = gamesData.filter(game => game.problem !== "true");

                // Sort games alphabetically by title
                gamesData.sort((a, b) => {
                    return a.title.localeCompare(b.title);
                });
                
                // Initialize filtered games with all games
                filteredGamesData = gamesData;
                
                // Render all games initially
                renderGames(gamesData);
                
                // Update filter count with initial count
                updateSearchInfo();
            })
            .catch(err => {
                console.error('Error loading games.json:', err);
                document.getElementById('gameGrid').textContent = "Échec du chargement des données de jeu.";
            });
    </script>
    <script>
    // --- Tooltip Functions (adapted from main.js) ---
    
    // Function to map core names to user-friendly system names
    function getSystemName(core) {
        if (!core) return '';
        const systemMap = {
            'arcade': 'Arcade (FBNeo)',
            'mame2003_plus': 'Arcade (MAME)',
            'atari2600': 'Atari 2600',
            'gb': 'Game Boy',
            'gba': 'Game Boy Advance',
            'segaMD': 'Sega Genesis/Mega Drive',
            'segaGG': 'Sega Game Gear',
            'jaguar': 'Atari Jaguar',
            'n64': 'Nintendo 64',
            'nes': 'Nintendo Entertainment System',
            'pce': 'PC Engine/TurboGrafx-16',
            'psx': 'PlayStation',
            'sega32x': 'Sega 32X',
            'segaMS': 'Sega Master System',
            'snes': 'Super Nintendo',
            'vb': 'Virtual Boy',
            'ws': 'WonderSwan'
        };
        return systemMap[core] || core;
    }
    
    function summarizeControls(controls) {
        if (!controls || !Array.isArray(controls)) return '';
        const joystickLines = controls.filter(line => String(line).trim().startsWith('🕹️'));
        if (joystickLines.length >= 2) return '🕹️🕹️';
        let summary = '';
        for (let line of controls) {
            line = String(line).trim();
            if (!line) continue;
            let first = line.split(' ')[0];
            if ([
                '1️⃣','2️⃣','3️⃣','4️⃣','5️⃣','6️⃣','7️⃣','8️⃣','9️⃣','0️⃣'
            ].includes(first)) {
                first = '🔴';
            }
            summary += first + ' ';
        }
        return summary.trim();
    }

    function showTooltipForItem(item) {
        removeTooltip(); // Clear any existing tooltip
        if (!item) return;
        let game = item._gameData;
        if (!game) return;
        const tooltip = document.createElement('div');
        tooltip.id = 'game-meta-tooltip';
        tooltip.className = 'game-meta-tooltip';
        
        // Get system name from core field
        const systemName = getSystemName(game.core);
        
        const fields = [
            { label: 'Développeur', key: 'developer' },
            { label: 'Année', key: 'year' },
            { label: 'Système', key: 'system', value: systemName },
            { label: 'Genre', key: 'genre' },
            { label: 'Recommandé par', key: 'recommended' },
            { label: 'Ajouté', key: 'added' }
        ];
        let hasData = false;
        const table = document.createElement('table');
        table.className = 'game-meta-table';
        fields.forEach(field => {
            let value = field.value !== undefined ? field.value : game[field.key];
            if (value) {
                hasData = true;
                const row = document.createElement('tr');
                const labelCell = document.createElement('td');
                labelCell.innerHTML = `<strong>${field.label}:</strong>`;
                labelCell.className = 'meta-label';
                const valueCell = document.createElement('td');
                valueCell.textContent = value;
                valueCell.className = 'meta-value';
                row.appendChild(labelCell);
                row.appendChild(valueCell);
                table.appendChild(row);
            }
        });
        if (game.controls && summarizeControls(game.controls)) {
            hasData = true;
            const row = document.createElement('tr');
            const labelCell = document.createElement('td');
            labelCell.innerHTML = `<strong>Contrôles:</strong>`;
            labelCell.className = 'meta-label';
            const valueCell = document.createElement('td');
            valueCell.textContent = summarizeControls(game.controls);
            valueCell.className = 'meta-value';
            row.appendChild(labelCell);
            row.appendChild(valueCell);
            table.appendChild(row);
        }
        if (hasData) {
            tooltip.appendChild(table);
            document.body.appendChild(tooltip);
            // Position tooltip near the item (fixed coordinates)
            const rect = item.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            let left = rect.right + 8;
            let top = rect.top;
            if (left + tooltipRect.width > window.innerWidth) {
                left = rect.left - tooltipRect.width - 8;
            }
            if (top + tooltipRect.height > window.innerHeight) {
                top = window.innerHeight - tooltipRect.height - 8;
            }
            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
        }
    }

    function removeTooltip() {
        const tooltip = document.getElementById('game-meta-tooltip');
        if (tooltip) tooltip.remove();
    }
    // Optional: Remove tooltip on click anywhere - only on non-mobile devices
    if (!isMobileDevice()) {
        document.addEventListener('click', removeTooltip);
    }
    </script>
</body>
</html>
