<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Loading Game...</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        /* Reset all elements to prevent overflow */
        * {
            box-sizing: border-box !important;
        }
        
        /* Basic styling to make the emulator fill the page */
        html, body { 
            margin: 0 !important; 
            padding: 0 !important; 
            height: 100% !important; 
            width: 100% !important;
            overflow: hidden !important; 
            background-color: #000 !important; 
            color: #eee !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
        }
        #game-container { 
            width: 100% !important; 
            height: 100% !important; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin: 0 !important;
            padding: 0 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            padding-bottom: env(safe-area-inset-bottom, 16px);
        }
        #game { 
            width: 100% !important; 
            height: 100% !important; 
            margin: 0 !important;
            padding: 0 !important;
        }
        .error-message { font-family: sans-serif; padding: 20px; text-align: center; color: #ffdddd; background-color: #330000; border: 1px solid red;}
        /* Styling for QR code */
        #qr-code-container {
            position: fixed !important;
            top: 10px !important;
            right: 10px !important;
            background-color: white;
            padding: 8px !important;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2000; /* Raised above banner */
            display: none; /* Hidden by default, will be shown by JS */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer; /* Indicate it's clickable */
            margin: 0 !important;
        }
        #qr-code-container p {
            font-family: sans-serif;
            font-size: 14px;
            color: #333;
            margin-top: 5px;
            margin-bottom: 0;
            text-align: center;
        }
        /* Leaderboard styling */
        #leaderboard-container {
            position: fixed !important;
            top: 140px !important;
            right: 10px !important;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px !important;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1999;
            display: none; /* Hidden by default, will be shown by JS */
            flex-direction: column;
            max-width: 280px;
            max-height: 350px;
            overflow-y: auto;
            font-family: sans-serif;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #leaderboard-container h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            text-align: center;
            color: #ffd700;
        }
        .leaderboard-entry {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            padding: 4px;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .leaderboard-rank {
            font-weight: bold;
            color: #ffd700;
            margin-right: 8px;
            min-width: 20px;
        }
        .leaderboard-player {
            flex: 1;
            margin-right: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .leaderboard-score {
            font-weight: bold;
            color: #00ff00;
        }
        .leaderboard-loading {
            text-align: center;
            color: #ccc;
            font-style: italic;
        }
        .leaderboard-error {
            text-align: center;
            color: #ff6b6b;
            font-style: italic;
        }
        /* Menu button styling */
        #menu-button {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px !important;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: sans-serif;
            font-size: 12px !important;
            z-index: 2000; /* Raised above banner */
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.2s;
            margin: 0 !important;
        }
        #menu-button:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }
        #menu-button .arrow {
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- Menu Button -->
    <div id="menu-button">
        <span class="arrow">‚Üê</span>
        <span>MENU</span>
    </div>
    <!-- Controls Overlay (desktop only) -->
    <div id="controls-overlay" style="display:none;position:fixed;top:52px;left:10px;z-index:1999;background:rgba(0,0,0,0.85);color:#fff;padding:8px 14px 8px 12px;border-radius:6px;font-size:18px;font-family:sans-serif;box-shadow:0 2px 8px #0005;min-width:40px;max-width:220px;line-height:1.5;pointer-events:none;"></div>

    <div id="game-container">
        <div id="game"><p style="text-align: center; padding-top: 50px;">Initializing...</p></div>
    </div>

    <!-- QR Code Container -->
    <div id="qr-code-container">
        <div id="qr-code"></div>
        <p>Classements</p>
    </div>

    <!-- Leaderboard Container -->
    <div id="leaderboard-container">
        <h3>üèÜ Meilleurs Scores</h3>
        <div id="leaderboard-content">
            <div class="leaderboard-loading">Chargement...</div>
        </div>
    </div>

    <script src="/assets/js/banner.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        function basename(path) {
            return path.split('/').pop().split('\\').pop();
        }

        // Custom buttons
        window.EJS_Buttons = {
          playPause: true,
          restart: true,
          mute: true,
          settings: true,
          fullscreen: true,
          saveState: true,
          loadState: true,
          screenRecord: true,
          gamepad: true,
          cheat: false,
          volume: true,
          saveSavFiles: false,
          loadSavFiles: false,
          quickSave: true,
          quickLoad: true,
          screenshot: true,
          cacheManager: true,
          customDownload: {
              visible: true,
              displayName: "Download this game",
              icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/><path d="M12,19L16,15H13V11H11V15H8L12,19Z"/></svg>',
              callback: () => {
                  downloadFile(window.EJS_gameUrl,
                    basename(window.EJS_gameUrl));
              }
          },
          exitEmulation: false
        };

        // Feature: Redirect to homepage at 5 AM local time
        function checkAndRedirectAt5AM() {
            const now = new Date();
            if (now.getHours() === 5 && window.screensaverActive) {
                console.log("It's 5 AM local time and screensaver is active. Redirecting to homepage.");
                window.location.href = "/index.html";
            }
        }

        // Set up interval to check every hour (3,600,000 milliseconds)
        setInterval(checkAndRedirectAt5AM, 3600000);

        // Hide screensaver timer on play page
        if (window.setScreensaverTimerVisibility) {
            window.setScreensaverTimerVisibility(false);
        }

        // Function to detect if the device is mobile
        function isMobileDevice() {
            return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        // Summarize controls (same logic as main menu/newsletter)
        function summarizeControls(controls) {
            if (!controls || !Array.isArray(controls)) return '';
            const joystickLines = controls.filter(line => String(line).trim().startsWith('üïπÔ∏è'));
            if (joystickLines.length >= 2) return 'üïπÔ∏èüïπÔ∏è';
            let summary = '';
            for (let line of controls) {
                line = String(line).trim();
                if (!line) continue;
                let first = line.split(' ')[0];
                if ([
                    '1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£','0Ô∏è‚É£'
                ].includes(first)) {
                    first = 'üî¥';
                }
                summary += first + ' ';
            }
            return summary.trim();
        }

        // --- Logic for the Single Game Launcher Page (using JSON Controls) ---

        /**
         * Displays an error message within the game container.
         * @param {string} message - The error message to display.
         */
        function showLauncherError(message) {
            const gameContainer = document.getElementById('game-container');
            if (gameContainer) {
                // Display the error message inside the main container
                gameContainer.innerHTML = `<p class="error-message">Error: ${message}</p>`;
            }
            // Also set a generic error title for the page tab
            document.title = "Error Loading Game";
        }

        /**
         * Main async function to:
         * 1. Get game ID from URL.
         * 2. Fetch game list data.
         * 3. Find the specific game's details.
         * 4. Fetch emulator settings.
         * 5. Fetch game controls (from JSON).
         * 6. Set up EmulatorJS variables.
         * 7. Load the EmulatorJS engine.
         */
        async function loadSelectedGame() {
            // Step 1: Get Game ID from URL parameter (?game=...)
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');

            if (!gameId) {
                window.location.href = "../";
            }
            console.log(`Attempting to load game with ID: ${gameId}`);

            // QR Code generation logic
            const qrCodeContainer = document.getElementById('qr-code-container');
            const leaderboardUrl = `https://alloarcade.web.app/leaderboards/${gameId}`;

            if (qrCodeContainer) {
                if (!isMobileDevice()) {
                    qrCodeContainer.style.display = 'flex'; // Show container for desktop
                    new QRCode(document.getElementById("qr-code"), {
                        text: leaderboardUrl,
                        width: 90,
                        height: 90,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                    // Make the container clickable for desktop
                    qrCodeContainer.addEventListener('click', () => {
                        window.open(leaderboardUrl, '_blank');
                    });
                } else {
                    // On mobile, hide the entire container
                    qrCodeContainer.style.display = 'none';
                }
            }

            // Leaderboard fetching logic
            async function fetchLeaderboard(gameId) {
                const leaderboardContainer = document.getElementById('leaderboard-container');
                const leaderboardContent = document.getElementById('leaderboard-content');
                
                if (!leaderboardContainer || !leaderboardContent) return;

                // Show loading state
                leaderboardContent.innerHTML = '<div class="leaderboard-loading">Chargement...</div>';
                
                try {
                    // Check if we're on localhost and use mock data
                    const isLocalhost = window.location.hostname === 'localhost' || 
                                      window.location.hostname === '127.0.0.1' || 
                                      window.location.hostname.includes('localhost');
                    
                    let data;
                    
                    if (isLocalhost) {
                        // Use mock data for localhost
                        console.log('Using mock leaderboard data for localhost');
                        data = {
                            result: {
                                success: true,
                                scores: generateMockScores(gameId)
                            }
                        };
                    } else {
                        // Use real API for production
                        const response = await fetch('https://us-central1-alloarcade.cloudfunctions.net/listGameScores', {
                            method: 'POST',
                            headers: {
                                'accept': '*/*',
                                'accept-language': 'en-CA,en;q=0.9,fr-CA;q=0.8,fr;q=0.7,en-GB;q=0.6,en-US;q=0.5',
                                'cache-control': 'no-cache',
                                'content-type': 'application/json',
                                'firebase-instance-id-token': 'd81DC0UGvyC6i41_okOipa:APA91bHNG-8qmIvzgyCLGKg54RBFwRyB2hx6QEcZ2BJUHcbmcvilEJnpCQscmrnOgpVrFlurW4Fg6b0Lkzs_Lzgl53iECK6E8-pPLVN_yHC8_beMww7Blxg',
                                'origin': 'https://alloarcade.web.app',
                                'pragma': 'no-cache',
                                'priority': 'u=1, i',
                                'referer': 'https://alloarcade.web.app/',
                                'sec-ch-ua': '"Not)A;Brand";v="8", "Chromium";v="138", "Google Chrome";v="138"',
                                'sec-ch-ua-mobile': '?0',
                                'sec-ch-ua-platform': '"Windows"',
                                'sec-fetch-dest': 'empty',
                                'sec-fetch-mode': 'cors',
                                'sec-fetch-site': 'cross-site',
                                'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'
                            },
                            body: JSON.stringify({
                                data: {
                                    timeRange: "all",
                                    gameId: gameId
                                }
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        data = await response.json();
                    }
                    
                    if (!data.result || !data.result.success || !data.result.scores) {
                        throw new Error('Invalid response format');
                    }

                    // Get best score for each unique player
                    const playerBestScores = new Map();
                    
                    data.result.scores.forEach(score => {
                        const userId = score.userId;
                        const currentBest = playerBestScores.get(userId);
                        
                        if (!currentBest || score.score > currentBest.score) {
                            playerBestScores.set(userId, {
                                player: score.player,
                                score: score.score,
                                rank: score.rank
                            });
                        }
                    });

                    // Convert to array and sort by score (highest first)
                    const sortedScores = Array.from(playerBestScores.values())
                        .sort((a, b) => b.score - a.score)
                        .slice(0, 10); // Show top 10 players

                    if (sortedScores.length === 0) {
                        leaderboardContent.innerHTML = '<div class="leaderboard-loading">Aucun score trouv√©</div>';
                        return;
                    }

                    // Build leaderboard HTML
                    let leaderboardHTML = '';
                    sortedScores.forEach((score, index) => {
                        const rank = index + 1;
                        const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
                        
                        leaderboardHTML += `
                            <div class="leaderboard-entry">
                                <div class="leaderboard-rank">${rankEmoji}</div>
                                <div class="leaderboard-player">${score.player}</div>
                                <div class="leaderboard-score">${score.score.toLocaleString()}</div>
                            </div>
                        `;
                    });

                    leaderboardContent.innerHTML = leaderboardHTML;
                    
                    // Show leaderboard container on desktop
                    if (!isMobileDevice()) {
                        leaderboardContainer.style.display = 'flex';
                    }

                } catch (error) {
                    console.error('Error fetching leaderboard:', error);
                    leaderboardContent.innerHTML = '<div class="leaderboard-error">Erreur de chargement</div>';
                }
            }

            // Mock data generator function
            function generateMockScores(gameId) {
                const mockPlayers = [
                    { name: "F√©lix L", userId: "user1" },
                    { name: "Marie C", userId: "user2" },
                    { name: "Jean P", userId: "user3" },
                    { name: "Sophie M", userId: "user4" },
                    { name: "Pierre D", userId: "user5" },
                    { name: "Alice R", userId: "user6" },
                    { name: "Thomas B", userId: "user7" },
                    { name: "Emma L", userId: "user8" }
                ];

                // Generate different score ranges based on game type
                let baseScore = 1000;
                if (gameId.includes('shmup') || gameId.includes('shoot')) {
                    baseScore = 50000;
                } else if (gameId.includes('puzzle')) {
                    baseScore = 5000;
                } else if (gameId.includes('platform')) {
                    baseScore = 15000;
                }

                return mockPlayers.map((player, index) => ({
                    rank: index + 1,
                    id: `mock_${player.userId}_${Date.now()}`,
                    userId: player.userId,
                    player: player.name,
                    photoURL: `https://via.placeholder.com/96/cccccc/666666?text=${player.name.charAt(0)}`,
                    score: Math.floor(baseScore * (1 + Math.random() * 5) * (1 - index * 0.1)),
                    game: gameId,
                    date: {
                        _seconds: Math.floor(Date.now() / 1000) - Math.floor(Math.random() * 86400 * 30), // Random date within last 30 days
                        _nanoseconds: Math.floor(Math.random() * 1000000000)
                    },
                    verified: true,
                    screenshotUrl: `https://via.placeholder.com/300x200/333333/ffffff?text=Screenshot`
                }));
            }

            // Fetch leaderboard data
            fetchLeaderboard(gameId);

            try {
                // Step 2: Fetch the master game list
                const listResponse = await fetch('/gamelist.json'); // Fetch from site root
                if (!listResponse.ok) {
                    throw new Error(`Failed to fetch game list '/gamelist.json' (Status: ${listResponse.status})`);
                }
                const gameData = await listResponse.json();

                // Step 3: Find the specific game data using the gameId
                console.log(`Searching for game ID '${gameId}' in game list...`);
                let selectedGame = null;
                if (gameData.gameOfTheWeek && gameData.gameOfTheWeek.id === gameId) {
                    selectedGame = gameData.gameOfTheWeek;
                } else if (gameData.previousGames) { // Check if previousGames exists
                    selectedGame = gameData.previousGames.find(game => game.id === gameId);
                }

                // Handle case where the game is not found in the list
                if (!selectedGame) {
                    throw new Error(`Game with ID '${gameId}' not found in game list.`);
                }
                console.log("Found game data:", selectedGame);

                // --- Hide leaderboard button if disable_score is true ---
                if (selectedGame.disable_score === true || selectedGame.disable_score === "true") {
                    const qrCodeContainer = document.getElementById('qr-code-container');
                    const leaderboardContainer = document.getElementById('leaderboard-container');
                    if (qrCodeContainer) qrCodeContainer.style.display = 'none';
                    if (leaderboardContainer) leaderboardContainer.style.display = 'none';
                }

                // Step 4: Check if the ROM or Core info for this game is missing
                if (selectedGame.romMissing === true || !selectedGame.romPath || !selectedGame.core || selectedGame.core === 'null') {
                     throw new Error(`Required files (ROM or Core info) for game '${selectedGame.title || gameId}' are missing according to gamelist.json.`);
                }

                // Step 5: Set the Page Title
                document.title = selectedGame.title || gameId; // Use game title or fallback to ID
                // Show controls overlay (desktop only)
                const controlsOverlay = document.getElementById('controls-overlay');
                if (controlsOverlay) {
                    if (!isMobileDevice() && selectedGame.controls && Array.isArray(selectedGame.controls) && selectedGame.controls.length > 0) {
                        // Build overlay HTML: 'Controls' on first line, then each control line
                        let html = '<div style="font-weight:bold;font-size:15px;margin-bottom:2px;">Contr√¥les</div>';
                        html += selectedGame.controls.map(line => `<div>${line}</div>`).join('');
                        if (selectedGame.to_start) {
                            // Replace '->' with a better looking right arrow
                            let toStartDisplay = selectedGame.to_start.replace(/->/g, '‚Üí');
                          html += '<div style="margin-top:10px;font-size:15px;"><span style="font-weight:bold;">Pour commencer:</span><br>' + toStartDisplay + '</div>';
                        }
                        controlsOverlay.innerHTML = html;
                        controlsOverlay.style.display = 'block';
                    } else {
                        controlsOverlay.style.display = 'none';
                    }
                }

                // Step 6: Set the Core EJS Variables Globally (used by EmulatorJS loader)
                console.log(`Setting EJS Vars - Core: ${selectedGame.core}, ROM: ${selectedGame.romPath}`);
                window.EJS_player = "#game";        // Emulator renders in the #game div
                window.EJS_core = selectedGame.core;    // Core name from gamelist.json
                window.EJS_gameUrl = selectedGame.romPath; // ROM path from gamelist.json
                window.EJS_loadStateURL = selectedGame.saveState !== '' ? selectedGame.saveState : undefined;

                // Step 7: Fetch General Emulator Settings
                console.log("Fetching emulator settings: /config/emulator_settings.json");
                const settingsResponse = await fetch('/config/emulator_settings.json'); // Absolute path
                if (!settingsResponse.ok) throw new Error(`Failed to load '/config/emulator_settings.json' (Status: ${settingsResponse.status})`);
                const settings = await settingsResponse.json();
                if (!settings) throw new Error("Emulator settings file loaded but contained invalid data.");

                // Step 8: Assign Fetched Settings Globally
                for (const [key, value] of Object.entries(settings)) {
                  window[`${key}`] = value;
                }

                // --- NEW: Attempt to load game-specific config.json ---
                try {
                  const gameConfigPath = `/games/${gameId}/config.json`;
                  console.log(`Attempting to fetch game-specific config: ${gameConfigPath}`);
                  const gameConfigResponse = await fetch(gameConfigPath);
                  if (gameConfigResponse.ok) {
                    const gameConfig = await gameConfigResponse.json();
                    if (!gameConfig || typeof gameConfig !== 'object') {
                      throw new Error(`Game config file '${gameConfigPath}' loaded but contained invalid JSON.`);
                    }
                    
                    // Log the game-specific config values
                    console.log(`Game-specific config values for ${gameId}:`);
                    for (const [key, value] of Object.entries(gameConfig)) {
                      console.log(`  ${key} = ${value}`);
                    }
                    
                    // Merge/override global settings with game-specific settings
                    for (const [key, value] of Object.entries(gameConfig)) {
                      window[`${key}`] = value;
                    }
                    console.log(`Game-specific config loaded and merged for: ${gameId}`);
                  } else if (gameConfigResponse.status !== 404) {
                    throw new Error(`Failed to load game config '${gameConfigPath}' (Status: ${gameConfigResponse.status})`);
                  } else {
                    console.log(`No game-specific config found for: ${gameId}`);
                  }
                } catch (gameConfigError) {
                  console.error(`Error loading or parsing game-specific config:`, gameConfigError);
                  showLauncherError(gameConfigError.message || `An error occurred loading game-specific config.`);
                  return;
                }

                console.log("Final merged emulator settings (global + game-specific):");
                // Log all EJS_* variables that are set
                for (const key of Object.keys(window)) {
                  if (key.startsWith('EJS_')) {
                    console.log(`  ${key} = ${window[key]}`);
                  }
                }

                window.EJS_backgroundImage =
                `${window.location.protocol}//${window.location.hostname}:${window.location.port}/games/${gameId}/cover.png`; // Set background to game's cover

                // Step 9: Fetch Controls JSON based on Core
                const coreName = window.EJS_core;
                const controlsJsonPath = `/config/controls_${coreName}.json`; // Path to control JSON file
                // Only fetch global controls if not set by per-game config
                if (typeof window.EJS_defaultControls === 'undefined') {
                  console.log(`Attempting to fetch controls: ${controlsJsonPath}`);
                  try {
                      const controlsResponse = await fetch(controlsJsonPath);
                      if (!controlsResponse.ok) {
                           // Handle file not found gracefully - use defaults
                           if (controlsResponse.status === 404) {
                                console.warn(`Controls file not found: ${controlsJsonPath}. Using EmulatorJS default controls.`);
                                window.EJS_defaultControls = { "0":{}, "1":{}, "2":{}, "3":{} }; // Use default empty controls (valid JSON)
                           } else {
                                // Throw error for other HTTP issues
                                throw new Error(`Failed to fetch controls file (Status: ${controlsResponse.status})`);
                           }
                      } else {
                          // Parse JSON and assign directly
                          const controlsData = await controlsResponse.json();
                          if (!controlsData) throw new Error(`Controls file '${controlsJsonPath}' loaded but contained invalid JSON.`);
                          window.EJS_defaultControls = controlsData; // Assign fetched object
                          console.log(`Controls assigned successfully for core: ${coreName}`);
                      }
                  } catch (controlsError) {
                       // Handle fetch/parse errors specifically for controls JSON
                       console.error(`Error loading or parsing controls from ${controlsJsonPath}:`, controlsError);
                       console.warn("Using EmulatorJS default controls due to controls loading error.");
                       window.EJS_defaultControls = { "0":{}, "1":{}, "2":{}, "3":{} }; // Fallback to default empty controls
                  }
                } else {
                  console.log('Using EJS_defaultControls from per-game config.json');
                }

                // Step 10: Load the main EmulatorJS engine (loader.js)
                // This now happens sequentially after successfully fetching/setting up everything else
                if (window.EJS_pathtodata) {
                    console.log("Loading EmulatorJS engine (loader.js)...");
                    const loaderScript = document.createElement('script');
                    // Use the path defined in emulator_settings.json
                    loaderScript.src = `${window.EJS_pathtodata}loader.js`;
                    loaderScript.onerror = () => {
                        console.error("CRITICAL: Error loading EmulatorJS 'loader.js' from:", loaderScript.src);
                        showLauncherError("Could not load the core emulator engine. Check network connection and EJS_pathtodata setting.");
                    };
                    document.body.appendChild(loaderScript);
                    console.log("EmulatorJS 'loader.js' script added to page.");
                } else {
                     console.error("EJS_pathtodata is not defined after loading settings. Cannot load emulator engine.");
                     showLauncherError("Emulator configuration error: Path to required emulator data is missing.");
                }

            } catch (error) { // Catch errors from initial fetches (gamelist, settings) or setup logic
                console.error("Error during game loading process:", error);
                showLauncherError(error.message || "An unexpected error occurred while preparing the game.");
            }
        }

        // --- Start the loading process once the DOM is ready ---
        // Using DOMContentLoaded ensures the #game-container element exists
        document.addEventListener('DOMContentLoaded', loadSelectedGame);

        // Initialize screensaver after game is loaded
        if (window.initScreensaver) {
            document.addEventListener('DOMContentLoaded', () => {
                window.initScreensaver();
            });
        }

        // Menu button referrer logic
        document.getElementById('menu-button').addEventListener('click', function() {
            if (sessionStorage.getItem('referrerAllGames') === '1') {
                sessionStorage.removeItem('referrerAllGames');
                window.location.href = '/all/';
            } else {
                window.location.href = '/';
            }
        });
    </script>
    <script src="../assets/js/screensaver.js"></script>
    <script>
    // --- Custom screensaver cycling for play/index.html only ---
    (function() {
      // Wait for screensaver.js to be loaded and DOM ready
      function cycleScreensaver() {
        let cycleActive = false;
        function toggleScreensaver() {
          if (cycleActive) {
            if (window.screensaverActive && typeof stopScreensaver === 'function') {
              stopScreensaver();
            }
          } else {
            if (!window.screensaverActive && typeof startScreensaver === 'function') {
              startScreensaver();
            }
          }
          cycleActive = !cycleActive;
        }
        // Start with the current state
        setInterval(toggleScreensaver, 10 * 60 * 1000); // 10 minutes
      }
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(cycleScreensaver, 1000);
      } else {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(cycleScreensaver, 1000);
        });
      }
    })();
    </script>
    <div id="screensaver-overlay" class="screensaver-overlay">
        <img id="screensaver-image" class="screensaver-image" src="" alt="Screensaver Image">
        <img id="screensaver-logo" class="screensaver-logo" src="" alt="BonjourArcade Logo">
    </div>
</body>
</html>
